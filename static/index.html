<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutor Pro 3090 - Ultimate</title>
    <style>
        :root { --bg-dark: #0f172a; --panel-bg: #1e293b; --ita: #00d2ff; --eng: #94a3b8; --sys: #f1f5f9; --accent: #38bdf8; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-dark); color: var(--sys); margin: 0; padding: 10px; display: flex; gap: 20px; height: 100vh; box-sizing: border-box; }
        .side-col { flex: 1; background: #020617; padding: 20px; border-radius: 20px; border: 1px solid #334155; overflow-y: auto; display: none; }
        .main-col { flex: 3; display: flex; flex-direction: column; }
        @media (min-width: 800px) { .side-col { display: block; } }
        .container { background: var(--panel-bg); padding: 20px; border-radius: 15px; border: 1px solid #334155; flex-grow: 1; display: flex; flex-direction: column; position: relative; }
        
        .top-btns { position: absolute; top: 15px; right: 15px; display: flex; gap: 8px; z-index: 10; }
        .stop-btn { background: #f59e0b; color: #fff; border: none; padding: 6px 12px; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .reset-btn { background: #ef4444; color: #fff; border: none; padding: 6px 12px; border-radius: 6px; font-weight: bold; cursor: pointer; }

        .chat-history { flex-grow: 1; background: #020617; overflow-y: auto; padding: 20px; border-radius: 10px; margin: 10px 0; border: 1px solid #1e293b; display: flex; flex-direction: column; gap: 10px; }
        
        .ita-block { display: block; font-size: 24px; font-weight: 800; color: var(--ita); padding: 15px 15px 35px 15px; border-radius: 10px; background: #0f172a; border: 2px solid #1e293b; cursor: pointer; position: relative; }
        .ita-block.ready { border-color: #facc15; }
        .ita-block.playing { border-color: #22c55e; background: #064e3b; }
        .ita-block.loading { opacity: 0.5; border-style: dashed; }
        
        /* Fixed Download Button UI */
        .dl-btn { 
            position: absolute; left: 10px; bottom: 8px; font-size: 11px; color: #94a3b8; 
            background: #1e293b; border: 1px solid #334155; padding: 4px 8px; border-radius: 4px;
            text-decoration: none; font-weight: bold;
        }
        .dl-btn:hover { background: #334155; color: white; }
        .play-hint { position: absolute; right: 10px; bottom: 8px; font-size: 11px; color: #facc15; }

        .eng-block { display: block; font-size: 16px; color: var(--eng); font-style: italic; border-left: 3px solid #475569; padding-left: 10px; margin: 5px 0; }
        .sys-block { display: block; font-size: 15px; color: #cbd5e1; }
        
        .settings-bar { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        label { font-size: 11px; color: #64748b; text-transform: uppercase; font-weight: bold; display: block; margin-bottom: 4px; }
        select, textarea { background: #1e293b; color: white; border: 1px solid #334155; border-radius: 8px; width: 100%; box-sizing: border-box; padding: 10px; font-family: inherit; }
        
        .btn { padding: 12px; border-radius: 8px; border: none; font-weight: bold; background: var(--accent); color: #0f172a; cursor: pointer; }
        .recording { background: #ef4444 !important; color: white; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        .vocab-item { background: #1e293b; padding: 10px; margin-bottom: 8px; border-radius: 6px; border-left: 3px solid #38bdf8; font-size: 14px; color: #e2e8f0; }

        .template-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        #templateSelect { width: auto; padding: 5px; font-size: 12px; background: #0f172a; border: 1px solid #334155; }
    </style>
</head>
<body>

    <div class="side-col">
        <h3 style="color: var(--ita); margin-top:0;">Vocabulary Log</h3>
        <div id="vocabList"></div>
    </div>

    <div class="main-col">
        <div class="container">
            <div class="top-btns">
                <button class="stop-btn" onclick="stopWork()">‚èπ STOP</button>
                <button class="reset-btn" onclick="resetAll()">‚ôª RESET</button>
            </div>

            <h2 style="margin:0 0 10px 0; color:var(--accent);">üáÆüáπ Tutor Pro 3090</h2>

            <div class="settings-bar">
                <div><label>Tutor Voice</label><select id="tutorSelect"><option>Loading...</option></select></div>
                <div><label>Input Mode</label><select id="sttLang"><option value="it">Italian</option><option value="en">English</option></select></div>
            </div>

            <div class="template-row">
                <label style="margin:0;">System Prompt</label>
                <select id="templateSelect" onchange="loadTemplate(this.value)">
                    <option value="">Load Template...</option>
                </select>
            </div>
            <textarea id="system" rows="2">Role: Professional Italian Tutor. Wrap Italian in ###START_AUDIO### and ###STOP_AUDIO###. Wrap English in @@@ENGLISH@@@ and @@@END_ENGLISH@@@.</textarea>

            <div class="chat-history" id="chatWindow"></div>
            
            <textarea id="input" rows="2" placeholder="Talk or type..."></textarea>
            
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button id="micBtn" class="btn" style="flex:1; background:#475569; color:white;">üé§ Speak</button>
                <button onclick="send()" class="btn" style="flex:2;">Send Message</button>
            </div>
            <audio id="player" style="display:none;"></audio>
        </div>
    </div>

<script>
let mediaRecorder, audioChunks = [], currentAbortController = null;
const win = document.getElementById("chatWindow"), textInput = document.getElementById("input"), mic = document.getElementById('micBtn'), player = document.getElementById("player");
let currentPlayingBlock = null;

// REFRESH SAFETY
window.addEventListener('beforeunload', function() {
    navigator.sendBeacon('/clear_audio');
    if (currentAbortController) currentAbortController.abort();
});

function stopWork() { 
    if(currentAbortController) currentAbortController.abort(); 
    player.pause(); player.currentTime = 0; 
    if(currentPlayingBlock) currentPlayingBlock.classList.remove("playing"); 
}

async function resetAll() { 
    stopWork(); win.innerHTML = ""; textInput.value = ""; document.getElementById("vocabList").innerHTML = ""; 
    try { await fetch('/clear_audio', { method: 'POST' }); } catch(e) {} 
}

async function init() {
    try {
        const res = await fetch('/get_tutors'); const data = await res.json();
        const select = document.getElementById("tutorSelect"); select.innerHTML="";
        data.tutors.forEach(name => { const opt = document.createElement("option"); opt.value = name; opt.innerText = name.toUpperCase(); select.appendChild(opt); });
    } catch(e){}

    try {
        const res = await fetch('/get_templates'); const data = await res.json();
        const tSelect = document.getElementById("templateSelect");
        data.templates.forEach(fname => { const opt = document.createElement("option"); opt.value = fname; opt.innerText = fname.replace('.txt',''); tSelect.appendChild(opt); });
    } catch(e){}
}
window.onload = init;

async function loadTemplate(filename) {
    if(!filename) return;
    const res = await fetch(`/template/${filename}`);
    const data = await res.json();
    if(data.content) document.getElementById("system").value = data.content;
}

// MICROPHONE (Touch Fix)
navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
    mediaRecorder.onstop = async () => {
        const formData = new FormData();
        formData.append('audio', new Blob(audioChunks));
        formData.append('language', document.getElementById('sttLang').value);
        const res = await fetch('/stt', { method: 'POST', body: formData });
        const data = await res.json();
        textInput.value = data.text;
    };
}).catch(e => { mic.innerText="Blocked (Flags)"; mic.disabled=true; });

function startRec(e) { if(e.type==='touchstart') e.preventDefault(); audioChunks=[]; mediaRecorder.start(); mic.classList.add('recording'); }
function stopRec(e) { if(e.type==='touchend') e.preventDefault(); if(mediaRecorder.state==='recording') mediaRecorder.stop(); mic.classList.remove('recording'); }

mic.addEventListener('mousedown', startRec); mic.addEventListener('touchstart', startRec);
mic.addEventListener('mouseup', stopRec); mic.addEventListener('touchend', stopRec);

// CHAT
async function send() {
    const text = textInput.value; if(!text) return;
    currentAbortController = new AbortController();
    const signal = currentAbortController.signal;
    addMessage(text, 'user-msg'); textInput.value = "";
    const botBubble = document.createElement("div"); win.appendChild(botBubble);
    let window_currentCBlock = null;

    try {
        const response = await fetch("/chat_stream", {
            method: "POST", headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ text, system: document.getElementById("system").value }),
            signal
        });
        const reader = response.body.getReader();
        const decoder = new TextDecoder("utf-8");
        let buffer = "";

        while (true) {
            const { done, value } = await reader.read(); if(done) break;
            const chunk = decoder.decode(value, {stream:true});
            const lines = chunk.split("\n");
            for(let line of lines) {
                if(!line.startsWith("data: ") || line.includes("[DONE]")) continue;
                try {
                    const data = JSON.parse(line.replace("data: ", ""));
                    const token = data.choices[0].delta.content || "";
                    buffer += token;
                    let tagMatch;
                    while((tagMatch = buffer.match(/(###START_AUDIO###|###STOP_AUDIO###|@@@ENGLISH@@@|@@@END_ENGLISH@@@)/))) {
                        const tag = tagMatch[0], parts = buffer.split(tag);
                        if(parts[0]) appendToken(window_currentCBlock || (window_currentCBlock=createBlock(botBubble,'sys')), parts[0]);
                        if(tag==="###START_AUDIO###") window_currentCBlock=createBlock(botBubble,'ita');
                        else if(tag==="###STOP_AUDIO###") { triggerTTS(window_currentCBlock, window_currentCBlock.innerText, signal); window_currentCBlock=createBlock(botBubble,'sys'); }
                        else if(tag==="@@@ENGLISH@@@") window_currentCBlock=createBlock(botBubble,'eng');
                        else if(tag==="@@@END_ENGLISH@@@") window_currentCBlock=createBlock(botBubble,'sys');
                        buffer = parts.slice(1).join(tag);
                    }
                    if(buffer.length > 10 && !buffer.includes("#") && !buffer.includes("@")) {
                        appendToken(window_currentCBlock || (window_currentCBlock=createBlock(botBubble,'sys')), buffer);
                        buffer = "";
                    }
                } catch(e) {}
            }
        }
        if(buffer) appendToken(window_currentCBlock || createBlock(botBubble,'sys'), buffer);
    } catch(e) {}
}

function createBlock(parent, type) {
    const el = document.createElement("span"); el.className = type==='ita' ? "ita-block loading" : (type==='eng' ? "eng-block" : "sys-block");
    parent.appendChild(el); win.scrollTop = win.scrollHeight; return el;
}
function appendToken(block, text) {
    const clean = text.replace(/[#@]/g, "");
    if(block.innerText.length > 0 && /^[a-zA-Z0-9√†√®√©√¨√≤√π]/.test(clean[0]) && !/[\s']/.test(block.innerText.slice(-1))) block.innerText += " ";
    block.innerText += clean; win.scrollTop = win.scrollHeight;
}
async function triggerTTS(element, text, signal) {
    if(text.length > 3) addToVocab(text);
    try {
        const res = await fetch("/tts_sentence", { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({ text, tutor: document.getElementById("tutorSelect").value }), signal });
        const data = await res.json();
        if(data.audio_url) {
            element.classList.remove("loading"); element.classList.add("ready");
            
            // Play Hint
            const hint = document.createElement("div"); hint.className="play-hint"; hint.innerText="‚ñ∂ Play";
            element.appendChild(hint);

            // Download Button
            const dl = document.createElement("a");
            dl.className = "dl-btn";
            dl.innerText = "üíæ Save MP3";
            const fname = data.audio_url.split('/').pop();
            dl.href = `/download_mp3/${fname}`;
            dl.onclick = (e) => e.stopPropagation(); // Don't play when clicking download
            element.appendChild(dl);

            element.onclick = () => { 
                player.pause(); if(currentPlayingBlock) currentPlayingBlock.classList.remove("playing");
                player.src = data.audio_url; player.play(); 
                element.classList.add("playing"); currentPlayingBlock = element; 
            };
            player.onended = () => { element.classList.remove("playing"); };
        }
    } catch(e) {}
}
function addToVocab(text) {
    const list = document.getElementById("vocabList"); const item = document.createElement("div"); item.className = "vocab-item"; item.innerText = text.length > 60 ? text.substring(0, 57)+"..." : text; list.insertBefore(item, list.firstChild);
}
function addMessage(t, c) {
    const d = document.createElement("div"); d.innerText = t; d.style.padding = "10px"; if (c === 'user-msg') { d.style.background = "#334155"; d.style.borderRadius = "10px"; d.style.alignSelf = "flex-end"; d.style.maxWidth = "80%"; d.style.marginLeft = "auto"; d.style.marginBottom = "20px"; } win.appendChild(d);
}
</script>
</body>
</html>