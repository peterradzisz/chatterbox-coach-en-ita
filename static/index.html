<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Italian Tutor Pro - Manual Mode</title>
    <style>
        :root {
            --bg-dark: #0f172a; --panel-bg: #1e293b; --ita-color: #00d2ff; 
            --eng-color: #94a3b8; --sys-color: #f1f5f9; --accent: #38bdf8;
        }
        body { font-family: 'Segoe UI', sans-serif; max-width: 1200px; margin: 20px auto; background: var(--bg-dark); color: var(--sys-color); display: flex; gap: 20px; }
        .main-col { flex: 3; }
        .side-col { flex: 1; background: #020617; padding: 20px; border-radius: 20px; border: 1px solid #334155; height: 800px; overflow-y: auto; }
        .container { background: var(--panel-bg); padding: 30px; border-radius: 20px; border: 1px solid #334155; position: relative; }
        
        .stop-btn { 
            position: absolute; top: 20px; right: 20px; background: #ef4444; color: white; border: none; 
            padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; 
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }

        .chat-history { background: #020617; height: 500px; overflow-y: auto; padding: 25px; border-radius: 12px; display: flex; flex-direction: column; gap: 15px; border: 1px solid #1e293b; }

        /* Block Styles */
        .ita-block { 
            display: block; font-size: 26px; font-weight: 800; color: var(--ita-color); 
            padding: 18px; border-radius: 12px; margin: 10px 0; background: #0f172a; 
            border: 2px solid #1e293b; cursor: pointer; transition: 0.2s; position: relative;
        }
        .ita-block:hover { border-color: var(--ita-color); background: #1e293b; }
        
        /* Ready State (Loaded but not playing) */
        .ita-block.ready { border-color: #facc15; background: #422006; }
        .ita-block.ready::after { content: "‚ñ∂ Click to Play"; position: absolute; right: 10px; bottom: 5px; font-size: 12px; color: #facc15; }

        /* Playing State */
        .ita-block.playing { border-color: #22c55e; background: #064e3b; }
        .ita-block.playing::after { content: "üîä Playing..."; position: absolute; right: 10px; bottom: 5px; font-size: 12px; color: #22c55e; }
        
        .ita-block.loading { opacity: 0.5; border-style: dashed; }

        .eng-block { display: block; font-size: 18px; color: var(--eng-color); font-style: italic; padding: 5px 15px; border-left: 3px solid #475569; }
        .sys-block { display: block; font-size: 16px; color: #cbd5e1; margin: 10px 0; }

        .settings-bar { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; background: #0f172a; padding: 20px; border-radius: 12px; margin-bottom: 10px; }
        label { font-size: 12px; color: #64748b; text-transform: uppercase; font-weight: bold; }
        select, textarea { background: #1e293b; color: white; border: 1px solid #334155; border-radius: 8px; width: 100%; box-sizing: border-box; }
        textarea { padding: 15px; resize: none; margin-top:5px; }
        .btn { padding: 12px 25px; border-radius: 8px; border: none; cursor: pointer; font-weight: 700; background: var(--accent); color: #0f172a; }
        .recording { background: #ef4444 !important; color: white; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        .vocab-item { background: #1e293b; padding: 10px; margin-bottom: 8px; border-radius: 6px; border-left: 3px solid #38bdf8; font-size: 14px; }
    </style>
</head>
<body>
    <div class="side-col">
        <h3 style="color: var(--ita-color); margin-top:0;">Vocabulary Log</h3>
        <div id="vocabList"></div>
    </div>
    <div class="main-col">
        <div class="container">
            <button class="stop-btn" onclick="stopAllAudio()">‚èπ STOP ALL</button>
            <h2 style="margin:0 0 10px 0; color: var(--accent);">üáÆüáπ Tutor Pro</h2>
            <div class="settings-bar">
                <div><label>Voice</label><select id="tutorSelect"><option>Loading...</option></select></div>
                <div><label>Mic</label><select id="sttLang"><option value="it">Italian</option><option value="en">English</option></select></div>
            </div>
            <label>System Prompt</label>
            <textarea id="system" rows="3">Role: Professional Italian Tutor. 
Format: Wrap Italian in ###START_AUDIO### and ###STOP_AUDIO###. Wrap English in @@@ENGLISH@@@ and @@@END_ENGLISH@@@. Use "..." for pauses.</textarea>
            <div class="chat-history" id="chatWindow"></div>
            <textarea id="input" rows="2" placeholder="Message..."></textarea>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button id="micBtn" class="btn" style="background:#475569; color:white;">üé§ Hold to Speak</button>
                <button onclick="send()" class="btn">Send</button>
                <button onclick="location.reload()" class="btn" style="background:#1e293b; color:#64748b; margin-left:auto;">Reset</button>
            </div>
            <audio id="player" style="display:none;"></audio>
        </div>
    </div>

<script>
let mediaRecorder, audioChunks = [];
const win = document.getElementById("chatWindow");
const textInput = document.getElementById("input");
const mic = document.getElementById('micBtn');
const player = document.getElementById("player");
let currentPlayingBlock = null;

function stopAllAudio() {
    player.pause();
    player.currentTime = 0;
    if (currentPlayingBlock) {
        currentPlayingBlock.classList.remove("playing");
        currentPlayingBlock = null;
    }
}

textInput.addEventListener("keydown", (e) => { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); send(); } });

async function loadTutors() {
    const res = await fetch('/get_tutors');
    const data = await res.json();
    const select = document.getElementById("tutorSelect");
    select.innerHTML = "";
    data.tutors.forEach(name => {
        const opt = document.createElement("option"); opt.value = name;
        opt.innerText = name.charAt(0).toUpperCase() + name.slice(1);
        select.appendChild(opt);
    });
}
window.onload = loadTutors;

navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
    mediaRecorder.onstop = async () => {
        const formData = new FormData();
        formData.append('audio', new Blob(audioChunks));
        formData.append('language', document.getElementById('sttLang').value);
        const res = await fetch('/stt', { method: 'POST', body: formData });
        const data = await res.json();
        textInput.value = data.text;
    };
});
mic.onmousedown = () => { audioChunks=[]; mediaRecorder.start(); mic.classList.add('recording'); };
mic.onmouseup = () => { if(mediaRecorder.state==='recording') mediaRecorder.stop(); mic.classList.remove('recording'); };

async function send() {
    const text = textInput.value; if (!text) return;
    const systemPrompt = document.getElementById("system").value;
    addMessage(text, 'user-msg');
    textInput.value = "";
    win.scrollTop = win.scrollHeight;

    const botBubble = document.createElement("div"); win.appendChild(botBubble);
    const response = await fetch("/chat_stream", { 
        method: "POST", 
        headers: {"Content-Type": "application/json"}, 
        body: JSON.stringify({ text, system: systemPrompt }) 
    });

    const reader = response.body.getReader();
    const decoder = new TextDecoder("utf-8");
    let mode = 'sys', currentBlock = createBlock(botBubble, 'sys'), buffer = "";

    while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        const lines = decoder.decode(value, {stream: true}).split("\n");
        for (const line of lines) {
            if (!line.startsWith("data: ") || line.includes("[DONE]")) continue;
            try {
                const token = JSON.parse(line.replace("data: ", "")).choices[0].delta.content || "";
                buffer += token;

                // --- IMPROVED TAG DETECTION & BUFFER FLUSHING ---
                if (buffer.includes("###START_AUDIO###")) {
                    let parts = buffer.split("###START_AUDIO###");
                    appendToken(currentBlock, parts[0]); // Flush everything before tag
                    mode = 'ita';
                    currentBlock = createBlock(botBubble, 'ita');
                    buffer = parts[1] || "";
                } 
                else if (buffer.includes("###STOP_AUDIO###")) {
                    let parts = buffer.split("###STOP_AUDIO###");
                    appendToken(currentBlock, parts[0]); // CRITICAL: Flush the remaining Italian (e.g., "stai")
                    triggerTTS(currentBlock, currentBlock.innerText);
                    mode = 'sys';
                    currentBlock = createBlock(botBubble, 'sys');
                    buffer = parts[1] || "";
                } 
                else if (buffer.includes("@@@ENGLISH@@@")) {
                    let parts = buffer.split("@@@ENGLISH@@@");
                    appendToken(currentBlock, parts[0]);
                    mode = 'eng';
                    currentBlock = createBlock(botBubble, 'eng');
                    buffer = parts[1] || "";
                } 
                else if (buffer.includes("@@@END_ENGLISH@@@")) {
                    let parts = buffer.split("@@@END_ENGLISH@@@");
                    appendToken(currentBlock, parts[0]);
                    mode = 'sys';
                    currentBlock = createBlock(botBubble, 'sys');
                    buffer = parts[1] || "";
                }

                // Normal streaming flush (keep small for responsiveness but safe from tags)
                if (buffer.length > 10 && !buffer.includes("#") && !buffer.includes("@")) {
                    appendToken(currentBlock, buffer);
                    buffer = "";
                }
            } catch(e) {}
        }
    }
    // FINAL FLUSH: Catch whatever is left at the very end of the stream
    if (buffer) appendToken(currentBlock, buffer);
}
function createBlock(parent, type) {
    const el = document.createElement("span");
    el.className = type === 'ita' ? "ita-block loading" : (type === 'eng' ? "eng-block" : "sys-block");
    parent.appendChild(el);
    return el;
}

function appendToken(block, text) {
    if (!text) return;
    const clean = text.replace(/[#@]/g, "");
    
    if (block.innerText.length > 0) {
        const lastChar = block.innerText.slice(-1);
        const firstChar = clean[0];
        // Only add space if we are bridging two distinct word characters
        if (/^[a-zA-Z0-9√†√®√©√¨√≤√π√Ä√à√â√å√í√ô]/.test(firstChar) && !/[\s'.,?!]/.test(lastChar)) {
            block.innerText += " ";
        }
    }
    block.innerText += clean;
}
async function triggerTTS(element, text) {
    if (text.length > 3) addToVocab(text);
    const res = await fetch("/tts_sentence", { 
        method: "POST", headers: {"Content-Type": "application/json"}, 
        body: JSON.stringify({ text, tutor: document.getElementById("tutorSelect").value }) 
    });
    const data = await res.json();
    if (data.audio_url) {
        element.classList.remove("loading");
        element.classList.add("ready"); // Visual indicator that it's clickable
        
        // MANUAL PLAY ON CLICK ONLY
        element.onclick = () => { 
            stopAllAudio();
            player.src = data.audio_url; 
            player.play(); 
            element.classList.remove("ready");
            element.classList.add("playing");
            currentPlayingBlock = element;
            player.onended = () => { element.classList.remove("playing"); element.classList.add("ready"); currentPlayingBlock = null; };
        };
    }
}

function addToVocab(text) {
    const vocabList = document.getElementById("vocabList");
    const item = document.createElement("div");
    item.className = "vocab-item";
    item.innerText = text.substring(0, 50) + "...";
    vocabList.insertBefore(item, vocabList.firstChild);
}

function addMessage(t, c) {
    const d = document.createElement("div"); d.innerText = t; d.style.padding = "10px";
    if (c === 'user-msg') { d.style.background = "#334155"; d.style.borderRadius = "10px"; d.style.alignSelf = "flex-end"; d.style.maxWidth = "80%"; d.style.marginLeft = "auto"; d.style.marginBottom = "20px"; }
    win.appendChild(d);
}
</script>
</body>
</html>