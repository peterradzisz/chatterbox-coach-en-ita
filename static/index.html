<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutor Pro 3090 - Network Mode</title>
    <style>
        :root {
            --bg-dark: #0f172a; --panel-bg: #1e293b; --ita-color: #00d2ff; 
            --eng-color: #94a3b8; --sys-color: #f1f5f9; --accent: #38bdf8;
        }
        body { font-family: 'Segoe UI', sans-serif; max-width: 1200px; margin: 10px auto; background: var(--bg-dark); color: var(--sys-color); display: flex; flex-direction: row; gap: 20px; padding: 10px; }
        
        /* Layout */
        .main-col { flex: 3; display: flex; flex-direction: column; }
        .side-col { flex: 1; background: #020617; padding: 20px; border-radius: 20px; border: 1px solid #334155; height: 85vh; overflow-y: auto; }
        .container { background: var(--panel-bg); padding: 25px; border-radius: 20px; border: 1px solid #334155; position: relative; }

        .stop-btn { 
            position: absolute; top: 20px; right: 20px; background: #ef4444; color: white; border: none; 
            padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; 
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4); z-index: 10;
        }

        .chat-history { background: #020617; height: 450px; overflow-y: auto; padding: 25px; border-radius: 12px; display: flex; flex-direction: column; gap: 15px; border: 1px solid #1e293b; margin-bottom: 15px; }

        /* Speech Blocks */
        .ita-block { 
            display: block; font-size: 26px; font-weight: 800; color: var(--ita-color); 
            padding: 18px; border-radius: 12px; margin: 10px 0; background: #0f172a; 
            border: 2px solid #1e293b; cursor: pointer; transition: 0.2s; position: relative;
        }
        .ita-block.loading { opacity: 0.5; border-style: dashed; cursor: wait; }
        .ita-block.ready { border-color: #facc15; background: #422006; }
        .ita-block.ready::after { content: "‚ñ∂ Click to Play"; position: absolute; right: 10px; bottom: 5px; font-size: 11px; color: #facc15; }
        .ita-block.playing { border-color: #22c55e; background: #064e3b; }
        .ita-block.playing::after { content: "üîä Playing..."; position: absolute; right: 10px; bottom: 5px; font-size: 11px; color: #22c55e; }

        .eng-block { display: block; font-size: 18px; color: var(--eng-color); font-style: italic; padding: 5px 15px; border-left: 3px solid #475569; margin-bottom: 10px; }
        .sys-block { display: block; font-size: 16px; color: #cbd5e1; margin: 5px 0; line-height: 1.5; }

        /* UI Elements */
        .settings-bar { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; background: #0f172a; padding: 15px; border-radius: 12px; margin-bottom: 10px; }
        label { font-size: 11px; color: #64748b; text-transform: uppercase; font-weight: bold; display: block; margin-bottom: 5px; }
        select, textarea { background: #1e293b; color: white; border: 1px solid #334155; border-radius: 8px; width: 100%; box-sizing: border-box; font-family: inherit; }
        textarea { padding: 12px; resize: none; }
        
        .btn { padding: 12px 25px; border-radius: 8px; border: none; cursor: pointer; font-weight: 700; background: var(--accent); color: #0f172a; }
        .recording { background: #ef4444 !important; color: white; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        .vocab-item { background: #1e293b; padding: 10px; margin-bottom: 8px; border-radius: 6px; border-left: 3px solid #38bdf8; font-size: 14px; }

        @media (max-width: 800px) {
            body { flex-direction: column; }
            .side-col { height: auto; order: 2; }
            .main-col { order: 1; }
        }
    </style>
</head>
<body>

    <div class="side-col">
        <h3 style="color: var(--ita-color); margin-top:0;">Vocabulary Log</h3>
        <div id="vocabList"></div>
    </div>

    <div class="main-col">
        <div class="container">
            <button class="stop-btn" onclick="killSwitch()">‚èπ RESET</button>
            <h2 style="margin:0 0 10px 0; color: var(--accent);">üáÆüáπ Tutor Pro 3090</h2>
            
            <div class="settings-bar">
                <div><label>Tutor Voice</label><select id="tutorSelect"><option>Loading...</option></select></div>
                <div><label>Input Mode</label><select id="sttLang"><option value="it">Italian</option><option value="en">English</option></select></div>
            </div>

            <label>Instructional Focus</label>
            <textarea id="system" rows="2">Role: Professional Italian Tutor. Wrap Italian in ###START_AUDIO### and ###STOP_AUDIO###. Wrap English in @@@ENGLISH@@@ and @@@END_ENGLISH@@@.</textarea>
            
            <div class="chat-history" id="chatWindow"></div>
            
            <textarea id="input" rows="2" placeholder="Type or use the microphone..."></textarea>
            
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button id="micBtn" class="btn" style="background:#475569; color:white; flex:1;">üé§ Hold to Speak</button>
                <button onclick="send()" class="btn" style="flex:2;">Send Message</button>
            </div>
            <audio id="player" style="display:none;"></audio>
        </div>
    </div>

<script>
let mediaRecorder, audioChunks = [], currentAbortController = null;
const win = document.getElementById("chatWindow"), textInput = document.getElementById("input"), mic = document.getElementById('micBtn'), player = document.getElementById("player");
let currentPlayingBlock = null;

// --- EMERGENCY RESET ---
function killSwitch() {
    if (currentAbortController) currentAbortController.abort();
    stopAllAudio();
    if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
    win.innerHTML = "";
    textInput.value = "";
    document.getElementById("vocabList").innerHTML = "";
    console.log("System Aborted.");
}

function stopAllAudio() {
    player.pause();
    player.currentTime = 0;
    if (currentPlayingBlock) {
        currentPlayingBlock.classList.remove("playing");
        currentPlayingBlock.classList.add("ready");
    }
}

// Enter key to send
textInput.addEventListener("keydown", (e) => { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); send(); } });

async function loadTutors() {
    const res = await fetch('/get_tutors');
    const data = await res.json();
    const select = document.getElementById("tutorSelect");
    select.innerHTML = "";
    data.tutors.forEach(name => {
        const opt = document.createElement("option"); opt.value = name;
        opt.innerText = name.charAt(0).toUpperCase() + name.slice(1);
        select.appendChild(opt);
    });
}
window.onload = loadTutors;

// --- MICROPHONE LOGIC ---
navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
    mediaRecorder.onstop = async () => {
        const formData = new FormData();
        formData.append('audio', new Blob(audioChunks));
        formData.append('language', document.getElementById('sttLang').value);
        const res = await fetch('/stt', { method: 'POST', body: formData });
        const data = await res.json();
        textInput.value = data.text;
    };
});
mic.onmousedown = () => { audioChunks=[]; mediaRecorder.start(); mic.classList.add('recording'); };
mic.onmouseup = () => { if(mediaRecorder.state==='recording') mediaRecorder.stop(); mic.classList.remove('recording'); };

// --- MAIN CHAT ENGINE ---
async function send() {
    const text = textInput.value; if (!text) return;
    
    currentAbortController = new AbortController();
    const signal = currentAbortController.signal;

    addMessage(text, 'user-msg');
    textInput.value = "";
    win.scrollTop = win.scrollHeight;

    const botBubble = document.createElement("div"); win.appendChild(botBubble);
    let window_currentCBlock = null;

    try {
        const response = await fetch("/chat_stream", { 
            method: "POST", 
            headers: {"Content-Type": "application/json"}, 
            body: JSON.stringify({ text, system: document.getElementById("system").value }),
            signal: signal
        });

        const reader = response.body.getReader();
        const decoder = new TextDecoder("utf-8");
        let buffer = "";

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value, { stream: true });
            const lines = chunk.split("\n");

            for (let line of lines) {
                line = line.trim();
                if (!line || line === "data: [DONE]") continue;

                if (line.startsWith("data: ")) {
                    try {
                        const data = JSON.parse(line.replace("data: ", ""));
                        const token = data.choices[0].delta.content || "";
                        buffer += token;

                        // TAG DETECTION
                        let tagMatch;
                        while ((tagMatch = buffer.match(/(###START_AUDIO###|###STOP_AUDIO###|@@@ENGLISH@@@|@@@END_ENGLISH@@@)/))) {
                            const tag = tagMatch[0];
                            const parts = buffer.split(tag);
                            
                            if (parts[0]) appendToken(window_currentCBlock || (window_currentCBlock = createBlock(botBubble, 'sys')), parts[0]);
                            
                            if (tag === "###START_AUDIO###") {
                                window_currentCBlock = createBlock(botBubble, 'ita');
                            } else if (tag === "###STOP_AUDIO###") {
                                triggerTTS(window_currentCBlock, window_currentCBlock.innerText, signal);
                                window_currentCBlock = createBlock(botBubble, 'sys');
                            } else if (tag === "@@@ENGLISH@@@") {
                                window_currentCBlock = createBlock(botBubble, 'eng');
                            } else if (tag === "@@@END_ENGLISH@@@") {
                                window_currentCBlock = createBlock(botBubble, 'sys');
                            }
                            buffer = parts.slice(1).join(tag);
                        }

                        // FLUSH BUFFER
                        if (buffer.length > 10 && !buffer.includes("#") && !buffer.includes("@")) {
                            if (!window_currentCBlock) window_currentCBlock = createBlock(botBubble, 'sys');
                            appendToken(window_currentCBlock, buffer);
                            buffer = "";
                        }
                    } catch (e) { console.error("JSON Error", e); }
                }
            }
        }
        if (buffer) appendToken(window_currentCBlock || createBlock(botBubble, 'sys'), buffer);
    } catch(e) { console.log("Stream stopped."); }
}

function createBlock(parent, type) {
    const el = document.createElement("span");
    el.className = type === 'ita' ? "ita-block loading" : (type === 'eng' ? "eng-block" : "sys-block");
    parent.appendChild(el);
    win.scrollTop = win.scrollHeight;
    return el;
}

function appendToken(block, text) {
    if (!text) return;
    const clean = text.replace(/[#@]/g, "");
    if (block.innerText.length > 0) {
        const lastChar = block.innerText.slice(-1);
        const firstChar = clean[0];
        if (/^[a-zA-Z0-9√†√®√©√¨√≤√π√Ä√à√â√å√í√ô]/.test(firstChar) && !/[\s'.,?!]/.test(lastChar)) {
            block.innerText += " ";
        }
    }
    block.innerText += clean;
    win.scrollTop = win.scrollHeight;
}

async function triggerTTS(element, text, signal) {
    if (text.length > 3) addToVocab(text);
    try {
        const res = await fetch("/tts_sentence", { 
            method: "POST", headers: {"Content-Type": "application/json"}, 
            body: JSON.stringify({ text, tutor: document.getElementById("tutorSelect").value }),
            signal: signal
        });
        const data = await res.json();
        if (data.audio_url) {
            element.classList.remove("loading");
            element.classList.add("ready");
            element.onclick = () => { 
                stopAllAudio();
                player.src = data.audio_url; 
                player.play(); 
                element.classList.remove("ready");
                element.classList.add("playing");
                currentPlayingBlock = element;
                player.onended = () => { element.classList.remove("playing"); element.classList.add("ready"); };
            };
        }
    } catch(e) { console.log("TTS Aborted"); }
}

function addToVocab(text) {
    const vocabList = document.getElementById("vocabList");
    const item = document.createElement("div");
    item.className = "vocab-item";
    item.innerText = text.length > 60 ? text.substring(0, 57) + "..." : text;
    vocabList.insertBefore(item, vocabList.firstChild);
}

function addMessage(t, c) {
    const d = document.createElement("div"); d.innerText = t; d.style.padding = "10px";
    if (c === 'user-msg') { d.style.background = "#334155"; d.style.borderRadius = "10px"; d.style.alignSelf = "flex-end"; d.style.maxWidth = "80%"; d.style.marginLeft = "auto"; d.style.marginBottom = "20px"; }
    win.appendChild(d);
}
</script>
</body>
</html>